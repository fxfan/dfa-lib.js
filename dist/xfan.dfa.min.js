/*! xfan.dfa - v0.1.0 - 2012-11-10
* https://github.com/fxfan/dfa.js
* Copyright (c) 2012 xfan; Licensed MIT */
var xfan=xfan||{};(function(){"use strict";var _extend=function(){var e=Array.prototype.shift.apply(arguments);for(var t=0;t<arguments.length;t++)for(var n in arguments[t])e[n]=arguments[t][n];return e},Class={};Class.create=function(){var proto={extend:function(){var e=function(){};return function(t){return e.prototype=t.prototype,this.prototype=new e,this.uber=t.prototype,this.prototype.constructor=this,this}}(),define:function(e){return _extend(this.prototype,e),this},defineStatic:function(e){return _extend(this,e),this}};return function(name){var def="(function "+name.replace(/\./g,"_")+"() {";def+="this.className = name;",def+="if (this.initialize) { this.initialize.apply(this, arguments); }",def+="})";var C=eval(def);return C.__proto__=proto,C}}();var Input=Class.create("Input").define({val:function(){throw"Input#val() method must be implemented by subclass"}}),CharInput=Class.create("CharInput").extend(Input).define({initialize:function(e){this.ch=e},val:function(){return this.ch}}).defineStatic({create:function(e){var t=[];for(var n=0;n<e.length;n++)t.push(new this(e.charAt(n)));return t}}),Label=Class.create("Label").define({match:function(e){throw"Label#match(input) method must be implemented by subclass"}}),CharLabel=Class.create("CharLabel").extend(Label);CharLabel.defineStatic({Single:Class.create("CharLabel.Single").extend(CharLabel).define({initialize:function(e){this.ch=e},match:function(e){return e.val()===this.ch}}),Range:Class.create("CharLabel.Range").extend(CharLabel).define({initialize:function(e,t){this.first=e,this.end=t},match:function(e){return e.val()>=this.first&&e.val()<=this.end}}),Include:Class.create("CharLabel.Include").extend(CharLabel).define({initialize:function(e){this.chars=e},match:function(e){return this.chars.indexOf(e.val())!=-1}}),Exclude:Class.create("CharLabel.Exclude").extend(CharLabel).define({initialize:function(e){this.chars=e},match:function(e){return this.chars.indexOf(e.val())==-1}}),Complex:Class.create("CharLabel.Complex").extend(CharLabel).define({initialize:function(e){this.includes=[],this.excludes=[];for(var t=0;t<e.length;t++){var n=e[t];if(n instanceof CharLabel.Range||n instanceof CharLabel.Include)this.includes.push(n);else{if(!(n instanceof CharLabel.Exclude))throw n instanceof CharLabel.Single?"CharLabel.Single can't constitute a Complex object":"unknown label class: "+n.className;this.excludes.push(n)}}},match:function(e){for(var t=0;t<this.excludes.length;t++)if(!this.excludes[t].match(e))return!1;for(var t=0;t<this.includes.length;t++)if(this.includes[t].match(e))return!0;return!1}})});var Edge=Class.create("Edge").define({initialize:function(e,t){this.label=e,this.dest=t},tryTransition:function(e,t){return this.label.match(e,t)?this.dest:null}}),State=Class.create("State").define({initialize:function(e,t,n){this.num=e,this.edges=t,this.obj=n},getAcceptedObject:function(){return this.obj},isAcceptable:function(){return this.obj!==null&&this.obj!==undefined},isEdgeExists:function(){return this.edges.length!==0}}),DFA=Class.create("DFA").define({initialize:function(){this.start=null,this.states={}},addStartState:function(e){this.start=e,this.states[e.num]=e},addState:function(e){this.states[e.num]=e},startNewTransition:function(){if(this.start===null)throw"start state is not set";return new Transition(this)}}),Transition=Class.create("Transition").define({initialize:function(e){this.dfa=e,this.current=e.start,this.session={}},transit:function(e){if(this.current==null)throw"this transition has already failed due to illegal structure of the dfa";for(var t=0;t<this.current.edges.length;t++){var n=this.current.edges[t],r=n.tryTransition(e,this.session);if(r===null)continue;this.current=this.dfa.states[r];if(this.current==null)throw"destination state '"+r+"' is not found";return!0}return!1},isAcceptable:function(){return this.current.isAcceptable()},isEdgeExists:function(){return this.current.isEdgeExists()},getAcceptedObject:function(){if(!this.isAcceptable())throw"current is not an accept state";return this.current.getAcceptedObject()}}),CharInputSequence=Class.create("CharInputSequence").define({initialize:function(e){this.str=e,this.nextLexis="",this.forwardingPointer=0,this.beginningPointer=0,this.enableUnget=!1},get:function(){if(this.forwardingPointer>=this.str.length)return null;var e=this.str.charAt(this.forwardingPointer++);return this.enableUnget=!0,this.nextLexis+=e,new CharInput(e)},unget:function(){if(!this.enableUnget)throw"call getc first";this.enableUnget=!1,this.forwardingPointer--,this.nextLexis=this.nextLexis.slice(0,this.nextLexis.length-1)},findLexis:function(){this.beginningPointer=this.forwardingPointer,this.enableUnget=!1;var e=this.nextLexis;return this.nextLexis="",e},hasNext:function(){return this.forwardingPointer<this.str.length}}),Token=Class.create("Token").define({initialize:function(e,t){this.lexis=e,this.obj=t}}),Parser=Class.create("Parser").define({initialize:function(e,t){this.dfa=e,this.input=t,this.$next=null},next:function(){if(this.hasNext()){var e=this.$next;return this.$next=null,e}return null},hasNext:function(){if(this.$next!==null)return!0;if(!this.input.hasNext())return!1;var e=this.dfa.startNewTransition(),t;while((t=this.input.get())!==null){if(e.transit(t))continue;if(e.isAcceptable()){this.input.unget();var n=this.input.findLexis();return this.$next=new Token(n,e.getAcceptedObject()),!0}throw"parse error. near '"+this.input.findLexis()+"'"}var n=this.input.findLexis();if(!e.isAcceptable())throw"parse error. near '"+n+"'";return this.$next=new Token(n,e.getAcceptedObject()),!0}});xfan.dfa={Input:Input,CharInput:CharInput,Label:Label,CharLabel:CharLabel,Edge:Edge,State:State,DFA:DFA,Transition:Transition,CharInputSequence:CharInputSequence,Token:Token,Parser:Parser}})();