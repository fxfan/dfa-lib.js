"use strict";var _createClass=function(){function defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&defineProperties(e.prototype,t),n&&defineProperties(e,n),e}}();function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperties(Array.prototype,{__dfajs_flatten:{value:function value(){return Array.prototype.concat.apply([],this)},enumerable:!1},__dfajs_uniq:{value:function value(){return this.filter(function(e,t,n){return n.indexOf(e)===t})},enumerable:!1},__dfajs_uniqAsString:{value:function value(){return this.map(function(e){return[e,e.toString()]}).filter(function(e,t,n){return n.findIndex(function(t){return t[1]===e[1]})===t}).map(function(e){return e[0]})},enumerable:!1},__dfajs_concatTo:{value:function value(e){return e.concat(this)},enumerable:!1}});var Input=function(){function Input(){_classCallCheck(this,Input)}return _createClass(Input,[{key:"val",value:function val(){throw"Input#val() must be implemented by subclasses"}}]),Input}(),CharInput=function(e){function CharInput(e){_classCallCheck(this,CharInput);var t=_possibleConstructorReturn(this,(CharInput.__proto__||Object.getPrototypeOf(CharInput)).call(this));return t.ch=e,_possibleConstructorReturn(t,Object.freeze(t))}return _inherits(CharInput,Input),_createClass(CharInput,[{key:"val",value:function val(){return this.ch}}],[{key:"create",value:function create(e){return e.split("").map(function(e){return new CharInput(e)})}}]),CharInput}(),Label=function(){function Label(){_classCallCheck(this,Label)}return _createClass(Label,[{key:"match",value:function match(e){throw"Label#match(input) must be implemented by subclasses"}},{key:"equals",value:function equals(e){throw"Label#equals(label) must be implemented by subclasses"}}]),Label}(),Epsilon=function(e){function Epsilon(){return _classCallCheck(this,Epsilon),_possibleConstructorReturn(this,(Epsilon.__proto__||Object.getPrototypeOf(Epsilon)).apply(this,arguments))}return _inherits(Epsilon,Label),_createClass(Epsilon,[{key:"match",value:function match(e){return!1}},{key:"equals",value:function equals(e){return this===e}},{key:"toString",value:function toString(){return"Label.E"}}]),Epsilon}();Label.E=new Epsilon;var CharLabel=function(e){function CharLabel(){return _classCallCheck(this,CharLabel),_possibleConstructorReturn(this,(CharLabel.__proto__||Object.getPrototypeOf(CharLabel)).apply(this,arguments))}return _inherits(CharLabel,Label),CharLabel}();CharLabel.Single=function(e){function CharLabel_Single(e){_classCallCheck(this,CharLabel_Single);var t=_possibleConstructorReturn(this,(CharLabel_Single.__proto__||Object.getPrototypeOf(CharLabel_Single)).call(this));return t.ch=e,_possibleConstructorReturn(t,Object.freeze(t))}return _inherits(CharLabel_Single,CharLabel),_createClass(CharLabel_Single,[{key:"match",value:function match(e){return e.val()===this.ch}},{key:"equals",value:function equals(e){return this.constructor.name===e.constructor.name&&this.ch===e.ch}},{key:"toString",value:function toString(){return"CharLabel.Single[ch="+this.ch+"]"}}]),CharLabel_Single}(),CharLabel.Range=function(e){function CharLabel_Range(e,t){_classCallCheck(this,CharLabel_Range);var n=_possibleConstructorReturn(this,(CharLabel_Range.__proto__||Object.getPrototypeOf(CharLabel_Range)).call(this));return n.first=e,n.end=t,_possibleConstructorReturn(n,Object.freeze(n))}return _inherits(CharLabel_Range,CharLabel),_createClass(CharLabel_Range,[{key:"match",value:function match(e){return e.val()>=this.first&&e.val()<=this.end}},{key:"equals",value:function equals(e){return this.constructor.name===e.constructor.name&&this.first===e.first&&this.end===e.end}},{key:"toString",value:function toString(){return"CharLabel.Range[first="+this.first+",end="+this.end+"]"}}]),CharLabel_Range}(),CharLabel.Include=function(e){function CharLabel_Include(e){_classCallCheck(this,CharLabel_Include);var t=_possibleConstructorReturn(this,(CharLabel_Include.__proto__||Object.getPrototypeOf(CharLabel_Include)).call(this));return t.chars=e,_possibleConstructorReturn(t,Object.freeze(t))}return _inherits(CharLabel_Include,CharLabel),_createClass(CharLabel_Include,[{key:"match",value:function match(e){return this.chars.includes(e.val())}},{key:"equals",value:function equals(e){return this.constructor.name===e.constructor.name&&this.chars===e.chars}},{key:"toString",value:function toString(){return"CharLabel.Include[chars="+this.chars+"]"}}]),CharLabel_Include}(),CharLabel.Exclude=function(e){function CharLabel_Exclude(e){_classCallCheck(this,CharLabel_Exclude);var t=_possibleConstructorReturn(this,(CharLabel_Exclude.__proto__||Object.getPrototypeOf(CharLabel_Exclude)).call(this));return t.chars=e,_possibleConstructorReturn(t,Object.freeze(t))}return _inherits(CharLabel_Exclude,CharLabel),_createClass(CharLabel_Exclude,[{key:"match",value:function match(e){return!this.chars.includes(e.val())}},{key:"equals",value:function equals(e){return this.constructor.name===e.constructor.name&&this.chars===e.chars}},{key:"toString",value:function toString(){return"CharLabel.Exclude[chars="+this.chars+"]"}}]),CharLabel_Exclude}(),CharLabel.Or=function(e){function CharLabel_Or(){_classCallCheck(this,CharLabel_Or);var e=_possibleConstructorReturn(this,(CharLabel_Or.__proto__||Object.getPrototypeOf(CharLabel_Or)).call(this));return e.labels=Object.freeze(Array.prototype.slice.call(arguments).sort()),_possibleConstructorReturn(e,Object.freeze(e))}return _inherits(CharLabel_Or,CharLabel),_createClass(CharLabel_Or,[{key:"match",value:function match(e){return this.labels.some(function(t){return t.match(e)})}},{key:"equals",value:function equals(e){if(this.constructor.name!==e.constructor.name)return!1;if(this.labels.length!==e.labels.length)return!1;for(var t=0;t<this.labels;t++)if(!this.labels[t].match(e.labels[t]))return!1;return!0}},{key:"toString",value:function toString(){return"CharLabel.Or[labels="+this.labels.join(",")+"]"}}]),CharLabel_Or}();var Edge=function(){function Edge(e,t){return _classCallCheck(this,Edge),this.label=e,this.dest=t,Object.freeze(this)}return _createClass(Edge,[{key:"hasSameLabelWith",value:function hasSameLabelWith(e){return this.label.equals(e.label)}},{key:"tryTransition",value:function tryTransition(e,t){return this.label.match(e,t)?this.dest:null}},{key:"changeDest",value:function changeDest(e){return new Edge(this.label,e)}},{key:"toString",value:function toString(){return"Edge(label="+this.label+", dest="+this.dest+")"}}]),Edge}(),State=function(){function State(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return _classCallCheck(this,State),this.num=e,this.edges=Object.freeze(t?t.slice():[]),this.attrs=Object.freeze(n?Object.assign({},n):{}),this.acceptable=!!r,this.obj=void 0===a?null:Object.freeze(a),Object.freeze(this)}return _createClass(State,[{key:"hasEpsilonMove",value:function hasEpsilonMove(){return this.edges.some(function(e){return e.label.equals(Label.E)})}},{key:"hasDuplicateEdge",value:function hasDuplicateEdge(){var e=new Set;return this.edges.forEach(function(t){return e.add(t.label.toString())}),e.size<this.edges.length}},{key:"getAcceptedObject",value:function getAcceptedObject(){return this.obj}},{key:"isAcceptable",value:function isAcceptable(){return this.acceptable}},{key:"isEdgeExists",value:function isEdgeExists(){return this.edges.length>0}},{key:"toAcceptable",value:function toAcceptable(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return new State(this.num,this.edges,this.attrs,!0,e)}},{key:"toUnacceptable",value:function toUnacceptable(){return new State(this.num,this.edges,this.attrs,!1,null)}},{key:"addEdges",value:function addEdges(e){return new State(this.num,this.edges.concat(e),this.attrs,this.acceptable,this.obj)}},{key:"changeEdgesDest",value:function changeEdgesDest(e,t){if(this.edges.some(function(t){return t.dest===e})){var n=this.edges.map(function(n){return n.dest===e?n.changeDest(t):n});return new State(this.num,n,this.attrs,this.acceptable,this.obj)}return this}},{key:"toString",value:function toString(){return"State(num="+this.num+", edges="+this.edges+", attrs="+this.attrs+", acceptable="+this.acceptable+", obj="+this.obj+")"}}]),State}(),StateNumSequence=function(){function StateNumSequence(e){_classCallCheck(this,StateNumSequence),this._origin=e,this._next=e}return _createClass(StateNumSequence,null,[{key:"newSequence",value:function newSequence(){return void 0===this._seed&&(this._seed=0),new StateNumSequence(65536*++this._seed)}}]),_createClass(StateNumSequence,[{key:"next",value:function next(){return this._checkRange(),this._next++}},{key:"peek",value:function peek(){return this._checkRange(),this._next}},{key:"_checkRange",value:function _checkRange(){if(this._next>this._origin+65535)throw"A sequence can only generate 65536 nums: "+this._origin+" ~ "+(this._origin+65535)}}]),StateNumSequence}(),Fragment=function(){function Fragment(e){if(_classCallCheck(this,Fragment),!Array.isArray(e)||0===e.length)throw"Parameter 'states' must be a non-empty array";return this.states=Object.freeze(e.slice()),Object.freeze(this)}return _createClass(Fragment,[{key:"toUnacceptable",value:function toUnacceptable(){return new Fragment(this.states.map(function(e){return e.toUnacceptable()}))}},{key:"toLastAcceptable",value:function toLastAcceptable(){return new Fragment(this.init.concat(this.last.toAcceptable()))}},{key:"concat",value:function concat(e){return new Fragment(this.init.concat(this.last.addEdges(e.headEdges)).concat(e.tail))}},{key:"merge",value:function merge(e){return Fragment.mergeAll([this,e])}},{key:"head",get:function get(){return this.states[0]}},{key:"tail",get:function get(){return this.states.slice(1)}},{key:"init",get:function get(){return this.states.slice(0,-1)}},{key:"last",get:function get(){return this.states[this.states.length-1]}},{key:"headEdges",get:function get(){return this.states[0].edges}}],[{key:"concatAll",value:function concatAll(e){var t=(e=e.slice()).shift();return e.reduce(function(e,t){return e.concat(t)},t)}},{key:"mergeAll",value:function mergeAll(e){var t=StateNumSequence.newSequence(),n=new State(t.next(),e.map(function(e){return new Edge(Label.E,e.head.num)})),r=new State(t.next(),[]);return new Fragment([n].concat(e.map(function(e){return e.init.concat(e.last.addEdges([new Edge(Label.E,r.num)]))})).concat(r).__dfajs_flatten())}}]),Fragment}(),DTransRecord=function(){function DTransRecord(e,t,n){return _classCallCheck(this,DTransRecord),this.num=e,this.states=Object.freeze(t.slice().sort(function(e,t){return e.num-t.num})),this.edges=Object.freeze(n.slice()),Object.freeze(this)}return _createClass(DTransRecord,[{key:"getKey",value:function getKey(){return DTransRecord.createKey(this.states)}},{key:"addEdge",value:function addEdge(e){return new DTransRecord(this.num,this.states,this.edges.concat(e))}}],[{key:"createKey",value:function createKey(e){return e.map(function(e){return e.num}).sort().toString()}}]),DTransRecord}(),NFA=function(){function NFA(){_classCallCheck(this,NFA),this.start=null,this.states={}}return _createClass(NFA,[{key:"addStartState",value:function addStartState(e){this.addState(e),this.start=e}},{key:"addState",value:function addState(e){this.states[e.num]=e}},{key:"getStateByNum",value:function getStateByNum(e,t){var n=this.states[e];if(void 0===n){if(t)throw t;return null}return n}},{key:"appendFragment",value:function appendFragment(e,t){var n=this,r=this.getStateByNum(t),a=r.addEdges([new Edge(Label.E,e.head.num)]);this.addState(a),this.start===r&&(this.start=a),e.states.forEach(function(e){return n.addState(e)})}},{key:"startNewTransition",value:function startNewTransition(){if(null===this.start)throw"Start state isn't set";return new NFATransition(this)}},{key:"getAllLabels",value:function getAllLabels(){var e=this;return Object.keys(this.states).map(function(t){return e.states[t].edges.map(function(e){return e.label}).filter(function(e){return e!==Label.E})}).__dfajs_flatten().__dfajs_uniqAsString()}},{key:"eClosure",value:function eClosure(e){var t=this;return Object.keys(e).map(function(n){return function _eclosure(e){return e.edges.filter(function(e){return e.label===Label.E}).map(function(n){return _eclosure(t.getStateByNum(n.dest,"State "+n.dest+"(linked from "+e.num+") not found"))}).__dfajs_flatten().__dfajs_concatTo([e])}(e[n])}).__dfajs_flatten().__dfajs_uniq()}},{key:"move",value:function move(e,t){var n=this;return e.reduce(function(e,r){return r.edges.filter(function(e){return e.label.equals(t)}).map(function(e){return n.getStateByNum(e.dest,"State "+e.dest+"(linked from "+r.num+") not found")}).__dfajs_concatTo(e)},[]).__dfajs_uniq()}},{key:"toDFA",value:function toDFA(){var e=this,t=StateNumSequence.newSequence(),n=this.getAllLabels(),r=this.eClosure([this.start]),a=new DTransRecord(t.next(),r,[]),s=a.getKey(),i=function _createTable(r,a){return n.reduce(function(n,a){var s=DTransRecord.createKey(r),i=e.eClosure(e.move(r,a)),u=DTransRecord.createKey(i);if(n[u]){var c=new Edge(a,n[u].num);return Object.assign({},n,_defineProperty({},s,n[s].addEdge(c)))}var l,o=new DTransRecord(t.next(),i,[]),h=new Edge(a,o.num);return n=Object.assign({},n,(_defineProperty(l={},s,n[s].addEdge(h)),_defineProperty(l,u,o),l)),_createTable(i,n)},a)}(r,_defineProperty({},s,a));return Object.keys(i).reduce(function(e,t){var n=i[t],r=n.states.reduce(function(e,t){Object.keys(t.attrs).reduce(function(e,n){var r=void 0===e[n]?[t.attrs[n]]:e[n].concat(t.attrs[n]);return Object.assign({},e,_defineProperty({},n,Object.freeze(r)))},e)},{}),a=n.states.some(function(e){return e.isAcceptable()}),u=n.states.filter(function(e){return e.isAcceptable()}).map(function(e){return e.getAcceptedObject()}),c=new State(n.num,n.edges,r,a,u.length>0?u[0]:null);return t===s?e.addStartState(c):e.addState(c),e},new DFA)}}]),NFA}(),NFATransition=function(){function NFATransition(e){_classCallCheck(this,NFATransition),this.nfa=e,this.currents=e.eClosure([e.start])}return _createClass(NFATransition,[{key:"move",value:function move(e){var t=this;return this.currents=this.nfa.eClosure(this.currents.reduce(function(n,r){return r.edges.map(function(t){return t.tryTransition(e)}).filter(function(e){return null!==e}).map(function(e){return t.nfa.getStateByNum(e,"State "+e+"(linked from "+r.num+") not found")}).__dfajs_concatTo(n)},[]).__dfajs_uniq()),0!==this.currents.length}},{key:"isAcceptable",value:function isAcceptable(){return this.currents.some(function(e){return e.isAcceptable()})}},{key:"isEdgeExists",value:function isEdgeExists(){return this.currents.some(function(e){return e.isEdgeExists()})}},{key:"getAcceptedObjects",value:function getAcceptedObjects(){var e=this.currents.filter(function(e){return e.isAcceptable()}).map(function(e){return e.getAcceptedObject()});if(0===e.length)throw"current state is not acceptable";return e}},{key:"getAcceptedObject",value:function getAcceptedObject(){return this.getAcceptedObjects()[0]}},{key:"getCurrents",value:function getCurrents(){return this.currents.slice()}}]),NFATransition}(),DFA=function(){function DFA(){_classCallCheck(this,DFA),this.start=null,this.states={}}return _createClass(DFA,[{key:"addStartState",value:function addStartState(e){this.addState(e),this.start=e}},{key:"addState",value:function addState(e){if(e.hasEpsilonMove())throw"The state has e-move";if(e.hasDuplicateEdge())throw"The state has duplicate edge";this.states[e.num]=e}},{key:"getStateByNum",value:function getStateByNum(e){return void 0===this.states[e]?null:this.states[e]}},{key:"appendFragment",value:function appendFragment(e,t){var n=this,r=this.getStateByNum(t),a=r.addEdges(e.headEdges);this.addState(a),this.start===r&&(this.start=a),e.tail.forEach(function(e){return n.addState(e)})}},{key:"startNewTransition",value:function startNewTransition(){if(null===this.start)throw"Start state isn't set";return new DFATransition(this)}}]),DFA}(),DFATransition=function(){function DFATransition(e){_classCallCheck(this,DFATransition),this.dfa=e,this.current=e.start,this.session={}}return _createClass(DFATransition,[{key:"transit",value:function transit(e){var t=this;if(null===this.current)throw"This transition has already failed due to illegal structure of the dfa";var n=this.current.edges.map(function(n){return n.tryTransition(e,t.session)}).find(function(e){return null!==e});if(!n)return!1;if(this.current=this.dfa.states[n],!this.current)throw"Destination state '"+n+"' is not found";return!0}},{key:"isAcceptable",value:function isAcceptable(){return this.current.isAcceptable()}},{key:"isEdgeExists",value:function isEdgeExists(){return this.current.isEdgeExists()}},{key:"getAcceptedObject",value:function getAcceptedObject(){if(!this.isAcceptable())throw"current state is not acceptable";return this.current.getAcceptedObject()}}]),DFATransition}(),CharInputSequence=function(){function CharInputSequence(e){_classCallCheck(this,CharInputSequence),this.str=e,this.nextLexis="",this.forwardingPointer=0,this.enableUnget=!1}return _createClass(CharInputSequence,[{key:"get",value:function get(){if(!this.hasNext())return null;var e=this.str.charAt(this.forwardingPointer++);return this.enableUnget=!0,this.nextLexis+=e,new CharInput(e)}},{key:"unget",value:function unget(){if(!this.enableUnget)throw"Call get before unget";this.enableUnget=!1,this.forwardingPointer--,this.nextLexis=this.nextLexis.slice(0,-1)}},{key:"findLexis",value:function findLexis(){this.enableUnget=!1;var e=this.nextLexis;return this.nextLexis="",e}},{key:"hasNext",value:function hasNext(){return this.forwardingPointer<this.str.length}}]),CharInputSequence}(),Token=function Token(e,t){_classCallCheck(this,Token),this.lexis=e,this.obj=t},Parser=function(){function Parser(e,t){_classCallCheck(this,Parser),this.dfa=e,this.input=t,this._next=null}return _createClass(Parser,[{key:"next",value:function next(){if(this.hasNext()){var e=this._next;return this._next=null,e}return null}},{key:"hasNext",value:function hasNext(){if(null!==this._next)return!0;if(!this.input.hasNext())return!1;for(var e=this.dfa.startNewTransition(),t=void 0;null!==(t=this.input.get());)if(!e.transit(t)){if(e.isAcceptable()){this.input.unget();var n=this.input.findLexis();return this._next=new Token(n,e.getAcceptedObject()),!0}throw"Parse error. near '"+this.input.findLexis()+"'"}var r=this.input.findLexis();if(!e.isAcceptable())throw"Parse error. near '"+r+"'";return this._next=new Token(r,e.getAcceptedObject()),!0}}]),Parser}(),Regex=function(){function Regex(e){_classCallCheck(this,Regex),this.expr=e}return _createClass(Regex,[{key:"toFragment",value:function toFragment(){var e=StateNumSequence.newSequence(),t=new State(e.next(),[]).toAcceptable(this.expr),n=this.expr.split("").reduce(function(t,n){var r=t[t.length-1],a=new State(e.next(),[]),s=new Edge(new CharLabel.Single(n),a.num);return t[t.length-1]=r.addEdges([s]),t.concat(a)},[new State(e.next(),[])]);return new Fragment(n.slice(0,-1).concat(n[n.length-1].addEdges(new Edge(Label.E,t.num))).concat(t))}}]),Regex}();module.exports={Input:Input,CharInput:CharInput,Label:Label,CharLabel:CharLabel,Edge:Edge,State:State,StateNumSequence:StateNumSequence,Fragment:Fragment,NFA:NFA,DFA:DFA,CharInputSequence:CharInputSequence,Token:Token,Parser:Parser,Regex:Regex};